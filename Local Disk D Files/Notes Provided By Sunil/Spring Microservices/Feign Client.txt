--accounts microservice ---
new dependency: Open Feign (spring-cloud-starter-openfeign)

on bootstrap class  - @EnableFeignClients  --> enables Feign client related functionalities inside our accounts microservice - so that accounts microservice can connect with other microservices

inorder to connect with Loans & cards microservices in a traditonal approach -we can use RestTemplate , WebClient and we pass the URL, request data, port number etc with the RestTemplate or WebClient 

when we use the OpenFeign client - we dont need to write the implementation code - we just have to write the declarative code (something like the approach that we used in Data JPA - not writing any implementation code - only declarative code)

# create client interface  - to help the account microservice to connect with the cards microservice

package com.zettamine.accounts.service.client;

@FeignClient("cards")  --> to use the openfeign libraries - name used to register cards microservice with eureka server
public interface CardsFeignClient {

    @GetMapping(value = "/api/fetch",consumes = "application/json")
    public ResponseEntity<CardsDto> fetchCardDetails(@RequestParam String mobileNumber); //should match with the cards microservice
}

copy the CardsDto and LoansDto from the respective microservices  and place it in accounts microservice dto package

-- behind the scenes - our CardsFeignClient will connect to the Eureka Server and try to fetch all the instances that are registered with the logical name "cards" - once it gets the instance information - it will cache those details for 30 seconds which is the default period and within 30 seconds it is not going to connect again with eureka server; instead it is going to leverage the details present in the cache. 

Based upon the IP details in the cache - it is going to invoke the api "/api/fetch" along with mobileNumber of Cards microservice 
-- all the implementation codes will be generated by OpenFeign client

create a similar feign client for loans microservice

package com.zettamine.accounts.service.client;
@FeignClient("loans")
public interface LoansFeignClient {

    @GetMapping(value = "/api/fetch",consumes = "application/json")
    public ResponseEntity<LoansDto> fetchLoanDetails(@RequestParam String mobileNumber);
}



--> create a new DTO class for sending response of account , cutsomer, loans and cards details - CustomerDetailsDto - to hold all details

package com.zettamine.accounts.dto;
@Data
public class CustomerDetailsDto {		---> take the detaiuls from CustomerDto
 private String name;
 private String email;
 private String mobileNumber;
 private AccountsDto accountsDto;
 private CardsDto cardsDto;
 private LoansDto loansDto;
}


--> create a new Controller -- CustomerController

package com.zettamine.accounts.controllers

@RestController
@RequestMapping(path="/api", produces = {MediaType.APPLICATION_JSON_VALUE})
@Validated
public class CustomerController {
    @GetMapping("/fetchCustomerDetails")
    public ResponseEntity<CustomerDetailsDto> fetchCustomerDetails(@RequestParam
                                                                   @Pattern(regexp="(^$|[0-9]{10})",message = "Mobile number must be 10 digits") String mobileNumber){
      return null;
    }
}




# create an interface in service package

package com.zettamine.accounts.service;	
public interface ICustomersService {
    CustomerDetailsDto fetchCustomerDetails(String mobileNumber);
}


# implementation class

@Service
@AllArgsConstructor
public class CustomersServiceImpl implements ICustomersService {

    private AccountsRepository accountsRepository;
    private CustomerRepository customerRepository;

    private CardsFeignClient cardsFeignClient;
    private LoansFeignClient loansFeignClient;

    @Override
    public CustomerDetailsDto fetchCustomerDetails(String mobileNumber) {   //refer AccountsServiceImpl
        Customer customer = customerRepository.findByMobileNumber(mobileNumber).orElseThrow(
                () -> new ResourceNotFoundException("Customer", "mobileNumber", mobileNumber)
        );
        Accounts accounts = accountsRepository.findByCustomerId(customer.getCustomerId()).orElseThrow(
                () -> new ResourceNotFoundException("Account", "customerId", customer.getCustomerId().toString())
        );

        CustomerDetailsDto customerDetailsDto = CustomerMapper.mapToCustomerDetailsDto(customer, new CustomerDetailsDto());
        customerDetailsDto.setAccountsDto(AccountsMapper.mapToAccountsDto(accounts, new AccountsDto()));

        ResponseEntity<LoansDto> loansDtoResponseEntity = loansFeignClient.fetchLoanDetails(mobileNumber);
        customerDetailsDto.setLoansDto(loansDtoResponseEntity.getBody());

        ResponseEntity<CardsDto> cardsDtoResponseEntity = cardsFeignClient.fetchCardDetails(mobileNumber);
        customerDetailsDto.setCardsDto(cardsDtoResponseEntity.getBody());

        return customerDetailsDto;
    }
}

--- inside CustomerMapper class
    public static CustomerDetailsDto mapToCustomerDetailsDto(Customer customer, CustomerDetailsDto customerDetailsDto) {
        customerDetailsDto.setName(customer.getName());
        customerDetailsDto.setEmail(customer.getEmail());
        customerDetailsDto.setMobileNumber(customer.getMobileNumber());
        return customerDetailsDto;
    }



-- in Controller class
package com.zettamine.accounts.controllers

@RestController
@RequestMapping(path="/api", produces = {MediaType.APPLICATION_JSON_VALUE})
@Validated
public class CustomerController {
    private final ICustomersService iCustomersService;

    public CustomerController(ICustomersService iCustomersService){
        this.iCustomersService = iCustomersService;
    }

    @GetMapping("/fetchCustomerDetails")
    public ResponseEntity<CustomerDetailsDto> fetchCustomerDetails(@RequestParam
                                                                   @Pattern(regexp="(^$|[0-9]{10})",message = "Mobile number must be 10 digits") String mobileNumber){
      CustomerDetailsDto customerDetailsDto = iCustomersService.fetchCustomerDetails(mobileNumber);
      return ResponseEntity.status(HttpStatus.SC_OK).body(customerDetailsDto);
    }
}


start eureka server, accounts, cards & loans ms

check in eureka dashboard

POST - http://localhost:8080/api/create
POST - http://localhost:9000/api/create?mobileNumber=xxxx    use the same mobile number
POST - http://localhost:8090/api/create?mobileNumber=xxxx    use the same mobile number

GET - http://localhost:8080/api/fetchCustomerDetails?mobileNumber=xxxx    

we have used to logic name of microservice - not IP address to invoke the other ms 
it will go and check in the service registry agent (eureka) - and will get the complete details of the "cards" / "loans" ms
